<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Ember Websockets &amp; nginx integration - Esteban Sastre</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Ember Websockets &amp; nginx integration" />
<meta property="og:description" content="How to integrate WebSockets using an Ember.js application running in an nginx server on docker." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/ember-websockets-nginx-integration/" />
<meta property="article:published_time" content="2017-07-31T18:29:28+00:00" />
<meta property="article:modified_time" content="2017-07-31T18:29:28+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Ember Websockets &amp; nginx integration"/>
<meta name="twitter:description" content="How to integrate WebSockets using an Ember.js application running in an nginx server on docker."/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" /><link rel="stylesheet" type="text/css" href="/css/dark.css" media="(prefers-color-scheme: dark)" />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
		<script src="/js/main.js"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
		<div class="avatar">
			<a href="/">
				<img src="wizard.png" alt="Esteban Sastre" />
			</a>
		</div>
	
	<h1 class="site-title"><a href="/">Esteban Sastre</a></h1>
	<div class="site-description"><p>Pretty much everything that crosses my mind, thoughts and ramblings</p><nav class="nav social">
			<ul class="flat"><li><a href="https://github.com/fr0gs/" title="Github"><i data-feather="github"></i></a></li><li><a href="/index.xml" title="RSS"><i data-feather="rss"></i></a></li></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">31</span>
							<span class="rest">Jul 2017</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">Ember Websockets &amp; nginx integration</h1>
				</div>
			</div>
					
			<div class="markdown">
				<p>In <a href="http://estebansastre.com/ember-nginx-docker-deployment-with-multi-stage-builds/">a previous article</a> I explained our approach at work to deploy an <strong>Ember.js</strong> application in an <strong>nginx</strong> server running on docker. Today I had to integrate an instance of that application to communicate with another microservice using <strong>WebSockets</strong>.</p>
<p>A simplified diagram of the architecture would be:</p>
<p><img src="/images/diag_disp.png" alt=""></p>
<p>All this services run using a docker-compose script like this one (it is a very simplified version):</p>
<p><strong>docker-compose.yml</strong>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  frontend:
    image: bde2020/ember-swarm-ui-frontend:0.6.0
    ports:
      - <span style="color:#a31515">&#34;88:80&#34;</span>
    links:
      - dispatcher:backend
    volumes:
      - ./config/frontend:/etc/nginx/conf.d

  dispatcher:
    image: semtech/mu-dispatcher:1.0.1
    links:
      - push-service:push-service
    volumes:
      - ./config/dispatcher:/config

  db:
    image: tenforce/virtuoso:1.2.0-virtuoso7.2.2

  push-service:
    image: tenforce/mu-push-service
    environment:
      - MU_SPARQL_ENDPOINT=http://database:8890/sparql
    links:
      - db:database
    ports:
      - <span style="color:#a31515">&#34;83:80&#34;</span>
</code></pre></div><p>The Dispatcher will proxy calls to other microservices based on the request path. This is very useful to avoid the frontend to have any information about other microservices host names. More information <a href="https://github.com/mu-semtech/mu-dispatcher">here</a>.</p>
<p>The push-service will listen for GET requests in the root path (/), open a websocket and start sending some json. The code in the frontend to test just taken from <a href="https://github.com/thoov/ember-websockets">ember-websockets</a>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#00f">export</span> <span style="color:#00f">default</span> Ember.Component.extend({
  websockets: Ember.inject.service(),

  didInsertElement() {
    <span style="color:#00f">this</span>._super(...arguments);
    <span style="color:#00f">const</span> socket = <span style="color:#00f">this</span>.get(<span style="color:#a31515">&#39;websockets&#39;</span>).socketFor(<span style="color:#a31515">&#39;ws://localhost/push-service/&#39;</span>);
    ...
  }
</code></pre></div><p>But this is not enough, nginx needs additional configuration to open and maintain a connection using WebSockets. Luckily, nginx has support for it since version 1.3, and can be activated by specifying the set of headers that start the handshake for the websockets protocol.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#008000"># Set the server to proxy requests to when used in configuration</span>
upstream backend_app {
    server backend;
}

<span style="color:#008000"># Server specifies the domain, and location the relative url</span>
server {
    ...

    <span style="color:#008000"># WebSockets support</span>
    location /push-service {
      proxy_pass http://backend_app;
      proxy_http_version 1.1;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection <span style="color:#a31515">&#34;upgrade&#34;</span>;
    }
  }
</code></pre></div><p>The call from the frontend is to <em>http://location/push-service</em>, but the Push-Service only understands calls to <em>/</em>, then why specify the location = /push-service in nginx's configuration file? This is thanks to the <em>Dispatcher</em>, that will detect the call to <em>http://localhost/push-service</em> and rewrite it to <em>http://push-service/</em>, having a link to it in the docker-compose.yml file.</p>
<p>Have fun!</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://www.nginx.com/blog/websocket-nginx/">https://www.nginx.com/blog/websocket-nginx/</a></li>
<li><a href="https://www.nginx.com/blog/realtime-applications-nginx/">https://www.nginx.com/blog/realtime-applications-nginx/</a></li>
<li><a href="https://www.tutorialspoint.com/articles/how-to-configure-nginx-as-reverse-proxy-for-websocket">https://www.tutorialspoint.com/articles/how-to-configure-nginx-as-reverse-proxy-for-websocket</a></li>
<li><a href="https://nginx.org/en/docs/http/websocket.html">https://nginx.org/en/docs/http/websocket.html</a></li>
<li><a href="https://serverfault.com/questions/376162/how-can-i-create-a-location-in-nginx-that-works-with-and-without-a-trailing-slas">https://serverfault.com/questions/376162/how-can-i-create-a-location-in-nginx-that-works-with-and-without-a-trailing-slas</a></li>
</ul>

			</div>

			<div class="tags">
				
					
						<ul class="flat">
							
							<li><a href="/tags/ember">ember</a></li>
							
							<li><a href="/tags/docker">docker</a></li>
							
							<li><a href="/tags/dockerfile">dockerfile</a></li>
							
							<li><a href="/tags/nginx">nginx</a></li>
							
						</ul>
					
				
			</div><div id="disqus_thread"></div>
<script type="text/javascript">
	(function () {
		
		
		if (window.location.hostname == "localhost")
			return;

		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		var disqus_shortname = 'ink-demo';
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
		Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-99848055-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script>feather.replace()</script>
</body>
</html>
