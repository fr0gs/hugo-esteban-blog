<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Healthchecks for nginx in docker - Esteban Sastre</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Healthchecks for nginx in docker" />
<meta property="og:description" content="Different healthcheck techniques to verify nginx docker services&#39; status." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/healthchecks-nginx-docker/" />
<meta property="article:published_time" content="2017-08-15T08:00:00+00:00" />
<meta property="article:modified_time" content="2017-08-15T08:00:00+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Healthchecks for nginx in docker"/>
<meta name="twitter:description" content="Different healthcheck techniques to verify nginx docker services&#39; status."/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" /><link rel="stylesheet" type="text/css" href="/css/dark.css" media="(prefers-color-scheme: dark)" />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
		<script src="/js/main.js"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
		<div class="avatar">
			<a href="/">
				<img src="wizard.png" alt="Esteban Sastre" />
			</a>
		</div>
	
	<h1 class="site-title"><a href="/">Esteban Sastre</a></h1>
	<div class="site-description"><p>Pretty much everything that crosses my mind, thoughts and ramblings</p><nav class="nav social">
			<ul class="flat"><li><a href="https://github.com/fr0gs/" title="Github"><i data-feather="github"></i></a></li><li><a href="/index.xml" title="RSS"><i data-feather="rss"></i></a></li></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">15</span>
							<span class="rest">Aug 2017</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">Healthchecks for nginx in docker</h1>
				</div>
			</div>
					
			<div class="markdown">
				<h1 id="introduction">Introduction</h1>
<p>Recently I faced a problem where I had two nginx servers connected sequentially, the first one acted as a proxy (let's call it <strong>nginx-proxy</strong>) between the frontend and another nginx server (let's call it <strong>nginx-server</strong>). All services were running in docker containers using the <em>docker-compose</em> script.</p>
<p>The <strong>nginx-proxy</strong> service would route (or dispatch, however you want to call it) requests to the <strong>nginx-server</strong> service, as well as other microservices. Nginx by default does healthchecks on the upstream servers. This has several uses, for example if it's worthy to proxy the request to a server that might be down instead of serving it's local copy of a cached asset.</p>
<p>But I thought, what if I wanted to have explicit healthchecks for the nginx servers, either by using specific tools or commands in this kind of <em>docker-compose</em> architecture?</p>
<h1 id="docker-only-techniques">Docker-only techniques</h1>
<!-- raw HTML omitted -->
<h2 id="healthcheck-dockerfile">Healthcheck Dockerfile</h2>
<p>This is the easiest type of healthcheck, it consists of each container taking care of checking it's own service's health status, but it can also be tricked into checking both the local container's status and performing additional tests for upstream servers.</p>
<p>It is implemented using the <code>HEALTHCHECK [options] CMD</code> instruction when <a href="https://docs.docker.com/engine/reference/builder/#healthcheck">building the docker image</a>, or when running the container using <a href="https://docs.docker.com/engine/reference/run/#healthcheck">specific command line flags</a>.</p>
<p>In order to check if the <strong>nginx-proxy</strong> server is healthy by curl'ing the server you could specify on it's <strong>Dockerfile</strong>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">FROM nginx:1.13

HEALTHCHECK --interval=5m --timeout=3s CMD curl --fail http://nginx.host.com/ || exit 1
EXPOSE 80
</code></pre></div><p>Or when running it using <code>docker run</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">λ docker run --name=nginx-proxy -d <span style="color:#a31515">\
</span><span style="color:#a31515"></span>        --health-cmd=<span style="color:#a31515">&#39;curl --fail http://nginx.host.com || exit 1&#39;</span> <span style="color:#a31515">\
</span><span style="color:#a31515"></span>        --health-interval=5m <span style="color:#a31515">\
</span><span style="color:#a31515"></span>        --health-timeout=3s <span style="color:#a31515">\
</span><span style="color:#a31515"></span>        nginx:1.13
</code></pre></div><p>It is important to note that docker healthchecks will not only be performed when the containers are starting, but they will be periodically executed to check container's status, as seen in <a href="https://medium.com/@lherrera/life-and-death-of-a-container-146dfc62f808">this example</a>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#008000"># Check that the nginx config file exists</span>
λ docker run --name=nginx-proxy -d <span style="color:#a31515">\
</span><span style="color:#a31515"></span>        --health-cmd=<span style="color:#a31515">&#39;stat /etc/nginx/nginx.conf || exit 1&#39;</span> <span style="color:#a31515">\
</span><span style="color:#a31515"></span>        nginx:1.13

λ docker inspect --format=<span style="color:#a31515">&#39;{{.State.Health.Status}}&#39;</span> nginx-proxy
healthy

λ docker exec nginx-proxy rm /etc/nginx/nginx.conf
λ sleep 5; docker inspect --format=<span style="color:#a31515">&#39;{{.State.Health.Status}}&#39;</span> nginx-proxy
unhealthy

<span style="color:#008000"># But creating the nginx.conf file again will make the container be healthy again</span>
λ docker exec nginx-container touch /etc/nginx/nginx.conf
λ sleep 5; docker inspect --format=<span style="color:#a31515">&#39;{{.State.Health.Status}}&#39;</span> nginx-proxy
healthy
</code></pre></div><!-- raw HTML omitted -->
<h2 id="healthcheck-on-docker-composeyml">Healthcheck on docker-compose.yml</h2>
<p>This is totally equivalent of running the docker container with the healthcheck related command line flags.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">healthcheck:
  test: [<span style="color:#a31515">&#34;CMD&#34;</span>, <span style="color:#a31515">&#34;curl&#34;</span>, <span style="color:#a31515">&#34;--fail&#34;</span>, <span style="color:#a31515">&#34;http://nginx.host.com&#34;</span>]
  interval: 1m30s
  timeout: 10s
  retries: 3s
</code></pre></div><!-- raw HTML omitted -->
<h2 id="using-depends-on-in-docker-composeyml">Using depends_on in docker-compose.yml</h2>
<p>There is no guarantee for this kind of healthcheck. I would not even call it one because what it does is expressing dependency between two or more services running inside a docker-compose script. This means, that it will only force the execution order of the containers, without caring of the services that are executing inside, for example:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">nginx-proxy:
  image: nginx:1.13
  depends_on:
    - resource
    - push-service
  links:
    - resource:resource
    - push-service:push-service
</code></pre></div><!-- raw HTML omitted -->
<h1 id="application-logic-techniques">Application logic techniques</h1>
<p>This kind of checks involve adding application logic directly, via configuration files or scripting.
<!-- raw HTML omitted --></p>
<h2 id="upstream-passive-nginx-server-checks">Upstream passive nginx server checks</h2>
<p>Nginx will monitor your connections for upstream server failures and try to resume them after some time. In my example, tests will be done from the <strong>nginx-proxy</strong> service to the upstream <strong>nginx-server</strong> service.</p>
<p><strong>nginx.conf</strong>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#008000"># Upstream server for nginx-server</span>
upstream nginx_server {
  server nginx-server max_fails=3 fail_timeout=30s;
}
</code></pre></div><p><strong>fail_timeout</strong> indicate the amount of time where the total <strong>max_fails</strong> number has to happen to mark the service unavailable.
<!-- raw HTML omitted --></p>
<h2 id="upstream-server-active-nginx-server-checks">Upstream server active nginx server checks</h2>
<p>In order to actively check the health of upstream servers, nginx can send special requests to verify it. It is as easy as adding the directive <code>health_check</code> in the <em>location</em> context, as long as there is a <em>proxy_pass</em> directive that specifies an upstream server:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">upstream nginx_server {
  server nginx-server;
}

server {
    location / {
        proxy_pass http://nginx_server;
        health_check;
    }
}
</code></pre></div><!-- raw HTML omitted -->
<h2 id="lua-scripting-on-nginx">Lua scripting on nginx</h2>
<p>Nginx provides the possibility of adding additional logic in the <strong>nginx.conf</strong> file by using the scripting language <a href="https://www.lua.org/">Lua</a>.</p>
<p>This feature come with the <strong>OpenResty</strong> package, but you can simply extend the <a href="https://hub.docker.com/r/danday74/nginx-lua/">danday74/nginx-lua</a> docker image. An example healthcheck scripted in lua can be found in <a href="https://www.willglynn.com/2013/12/03/health-checks-in-nginx/">this post</a>.</p>
<p>Have fun!</p>

			</div>

			<div class="tags">
				
					
						<ul class="flat">
							
							<li><a href="/tags/nginx">nginx</a></li>
							
							<li><a href="/tags/docker">docker</a></li>
							
							<li><a href="/tags/dockerfile">dockerfile</a></li>
							
						</ul>
					
				
			</div><div id="disqus_thread"></div>
<script type="text/javascript">
	(function () {
		
		
		if (window.location.hostname == "localhost")
			return;

		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		var disqus_shortname = 'ink-demo';
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
		Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-99848055-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script>feather.replace()</script>
</body>
</html>
