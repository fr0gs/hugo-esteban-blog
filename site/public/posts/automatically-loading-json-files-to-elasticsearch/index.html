<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Automatically loading json files to ElasticSearch - Esteban Sastre</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Automatically loading json files to ElasticSearch" />
<meta property="og:description" content="A small script to load automatically json files into ElasticSearch containers and visualize them with Kibana. " />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/automatically-loading-json-files-to-elasticsearch/" />
<meta property="article:published_time" content="2017-07-13T07:27:26+00:00" />
<meta property="article:modified_time" content="2017-07-13T07:27:26+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Automatically loading json files to ElasticSearch"/>
<meta name="twitter:description" content="A small script to load automatically json files into ElasticSearch containers and visualize them with Kibana. "/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" /><link rel="stylesheet" type="text/css" href="/css/dark.css" media="(prefers-color-scheme: dark)" />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
		<script src="/js/main.js"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
		<div class="avatar">
			<a href="/">
				<img src="wizard.png" alt="Esteban Sastre" />
			</a>
		</div>
	
	<h1 class="site-title"><a href="/">Esteban Sastre</a></h1>
	<div class="site-description"><p>Pretty much everything that crosses my mind, thoughts and ramblings</p><nav class="nav social">
			<ul class="flat"><li><a href="https://github.com/fr0gs/" title="Github"><i data-feather="github"></i></a></li><li><a href="/index.xml" title="RSS"><i data-feather="rss"></i></a></li></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">13</span>
							<span class="rest">Jul 2017</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">Automatically loading json files to ElasticSearch</h1>
				</div>
			</div>
					
			<div class="markdown">
				<h1 id="introduction">Introduction</h1>
<p>Right now at work I am working in the (<a href="https://www.big-data-europe.eu/">Big Data Europe</a>) project, a joint effort or several organizations and enterprises accross Europe to create a platform that provides a set of software services that allow to implement big data pipelines, with minimal effort compared to other stacks and in an extremely cost effective way.</p>
<p>This is to make any company or organization that wants to make sense of their data using Big Data an easy starter to play around with the technologies that allow so.</p>
<p>One of the pieces I developed is <a href="https://github.com/big-data-europe/mu-bde-logging">mu-bde-logging</a>, a standalone system that allows to log HTTP traffic from running docker containers and post it into an EL(K) stack in real time for further visualization.</p>
<p>Last requirement was to add the possibility to replay old traffic backups and post them into the <strong>ElasticSearch</strong> instance to visualize them offline in <strong>Kibana</strong>.</p>
<p>So I wrote a small script to scan for the transformed <strong>.ha</strong> files (json format) in a given folder and replay them into the ElasticSearch container.
Since ElasticSearch &amp; Kibana containers are part of a <em>docker-compose.yml</em> project, I didn't care much about being generic and used the name the <em>docker-compose</em> script will give the containers, but it is easy to change &amp; extend.</p>
<h1 id="the-code">The Code</h1>
<p>This is what I came up with:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#00f">#!/usr/bin/env bash
</span><span style="color:#00f"></span>
<span style="color:#008000">#/ Usage: ./backup_replay.sh &lt;backups_folder&gt;</span>
<span style="color:#008000">#/ Description: Run ElasticSearch and Kibana standalone and post every enriched .har file in the backups folder to ElasticSearch.</span>
<span style="color:#008000">#/ Examples: ./backup_replay.sh backups/</span>
<span style="color:#008000">#/ Options:</span>
<span style="color:#008000">#/     --help: Display this help message</span>
usage() { grep <span style="color:#a31515">&#39;^#/&#39;</span> <span style="color:#a31515">&#34;</span>$0<span style="color:#a31515">&#34;</span> | cut -c4- ; exit 0 ; }
expr <span style="color:#a31515">&#34;</span>$*<span style="color:#a31515">&#34;</span> : <span style="color:#a31515">&#34;.*--help&#34;</span> &gt; /dev/null &amp;&amp; usage

BACKUP_DIR=<span style="color:#a31515">&#34;../backups/&#34;</span>

<span style="color:#008000"># Convenience logging function.</span>
info()    { echo <span style="color:#a31515">&#34;</span><span style="color:#a31515">[INFO]    </span>$@<span style="color:#a31515">&#34;</span>  ; }

cleanup() {
  true;
}

<span style="color:#008000"># Poll the ElasticSearch container</span>
poll() {
  local elasticsearch_ip=<span style="color:#a31515">&#34;</span>$1<span style="color:#a31515">&#34;</span>
  local result=<span style="color:#00f">$(</span>curl -XGET http://<span style="color:#a31515">${</span>elasticsearch_ip<span style="color:#a31515">}</span>:9200 -I 2&gt;/dev/null | head -n 1 | awk <span style="color:#a31515">&#39;{ print $2 }&#39;</span><span style="color:#00f">)</span>

  <span style="color:#00f">if</span> [[ $result == <span style="color:#a31515">&#34;200&#34;</span> ]]; <span style="color:#00f">then</span>
    <span style="color:#00f">return</span> 1 <span style="color:#008000"># ElasticSearch is up.</span>
  <span style="color:#00f">else</span>
    <span style="color:#00f">return</span> 0 <span style="color:#008000"># It will execute as long as the return code is zero.</span>
  <span style="color:#00f">fi</span>
}

<span style="color:#008000"># Parse Parameters</span>
<span style="color:#00f">while</span> [ <span style="color:#a31515">&#34;</span>$#<span style="color:#a31515">&#34;</span> -gt 1 ];
  <span style="color:#00f">do</span>
  key=<span style="color:#a31515">&#34;</span>$1<span style="color:#a31515">&#34;</span>

  <span style="color:#00f">case</span> $key in
      -f|--folder)
      BACKUP_DIR=<span style="color:#a31515">&#34;</span>$2<span style="color:#a31515">&#34;</span> <span style="color:#008000"># EXAMPLE</span>
      shift
      ;;
      --default)
      default=YES
      ;;
    *)
    ;;
  <span style="color:#00f">esac</span>
  shift
<span style="color:#00f">done</span>


<span style="color:#00f">if</span> [[ <span style="color:#a31515">&#34;</span><span style="color:#a31515">${</span>BASH_SOURCE[0]<span style="color:#a31515">}</span><span style="color:#a31515">&#34;</span> = <span style="color:#a31515">&#34;</span>$0<span style="color:#a31515">&#34;</span> ]]; <span style="color:#00f">then</span>
    trap cleanup EXIT

    <span style="color:#008000"># Start Elasticsearch &amp; Kibana with docker Compose</span>
    which docker-compose &gt;/dev/null
    <span style="color:#00f">if</span> (( <span style="color:#00f">$(</span>echo $?<span style="color:#00f">)</span> == <span style="color:#a31515">&#34;0&#34;</span> )); <span style="color:#00f">then</span>
      docker-compose up -d elasticsearch kibana
    <span style="color:#00f">else</span>
      info <span style="color:#a31515">&#34;Install docker-compose!&#34;</span>
      exit -1
    <span style="color:#00f">fi</span>

    <span style="color:#008000"># Poll ElasticSearch until it is up and we can post hars to it.</span>
    elasticsearch_ip=<span style="color:#00f">$(</span>docker inspect --format=<span style="color:#a31515">&#39;{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}&#39;</span> mubdelogging_elasticsearch_1<span style="color:#00f">)</span>

    info <span style="color:#a31515">&#34;</span><span style="color:#a31515">ElasticSearch container ip: </span><span style="color:#a31515">${</span>elasticsearch_ip<span style="color:#a31515">}</span><span style="color:#a31515">&#34;</span>

    <span style="color:#00f">while</span> poll <span style="color:#a31515">${</span>elasticsearch_ip<span style="color:#a31515">}</span>
    <span style="color:#00f">do</span>
      info <span style="color:#a31515">&#34;ElasticSearch is not up yet.&#34;</span>
      sleep 2
    <span style="color:#00f">done</span>

    <span style="color:#008000"># Find all .trans.har files in the specified backups folder/</span>
    <span style="color:#008000"># Per each one, pos to ElasticSearch.</span>
    info <span style="color:#a31515">&#34;Ready to work!&#34;</span>
    info <span style="color:#a31515">&#34;POST all enriched hars &#34;</span>
    find <span style="color:#a31515">${</span>BACKUP_DIR<span style="color:#a31515">}</span> -name <span style="color:#a31515">&#34;*.trans.har&#34;</span> | sed <span style="color:#a31515">&#39;s/^/@/g&#39;</span> | xargs -i /bin/bash -c <span style="color:#a31515">&#34;</span><span style="color:#a31515">sleep 0.5; curl -XPOST &#39;http://</span>$elasticsearch_ip<span style="color:#a31515">:9200/hars/har?pretty&#39; --data-binary {}</span><span style="color:#a31515">&#34;</span>
<span style="color:#00f">fi</span>
</code></pre></div><p>Have fun!</p>

			</div>

			<div class="tags">
				
					
						<ul class="flat">
							
							<li><a href="/tags/bash">bash</a></li>
							
							<li><a href="/tags/elasticsearch">elasticsearch</a></li>
							
							<li><a href="/tags/kibana">kibana</a></li>
							
							<li><a href="/tags/docker">docker</a></li>
							
						</ul>
					
				
			</div><div id="disqus_thread"></div>
<script type="text/javascript">
	(function () {
		
		
		if (window.location.hostname == "localhost")
			return;

		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		var disqus_shortname = 'ink-demo';
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
		Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-99848055-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script>feather.replace()</script>
</body>
</html>
