<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Sed tricked me! - Esteban Sastre</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Sed tricked me!" />
<meta property="og:description" content="Automating and scripting a process at work led to the discovery of  a particular behavior in sed when you try to execute a command in the substituting part." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/sed-tricked-me/" />
<meta property="article:published_time" content="2017-07-09T15:53:20+00:00" />
<meta property="article:modified_time" content="2017-07-09T15:53:20+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Sed tricked me!"/>
<meta name="twitter:description" content="Automating and scripting a process at work led to the discovery of  a particular behavior in sed when you try to execute a command in the substituting part."/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" /><link rel="stylesheet" type="text/css" href="/css/dark.css" media="(prefers-color-scheme: dark)" />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
		<script src="/js/main.js"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
		<div class="avatar">
			<a href="/">
				<img src="wizard.png" alt="Esteban Sastre" />
			</a>
		</div>
	
	<h1 class="site-title"><a href="/">Esteban Sastre</a></h1>
	<div class="site-description"><p>Pretty much everything that crosses my mind, thoughts and ramblings</p><nav class="nav social">
			<ul class="flat"><li><a href="https://github.com/fr0gs/" title="Github"><i data-feather="github"></i></a></li><li><a href="/index.xml" title="RSS"><i data-feather="rss"></i></a></li></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">09</span>
							<span class="rest">Jul 2017</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">Sed tricked me!</h1>
				</div>
			</div>
					
			<div class="markdown">
				<h1 id="introduction">Introduction</h1>
<p>Today I had some time free at work since I am between projects and I wait for some additional information, and I took advantage of it to help a coworker that was new to <strong>Ember.js</strong>. For some reason all the calls to the backend (a Virtuoso Database) failed.</p>
<p>Taking a look together, we discovered that the middleware that transformed JSON-API calls into SPARQL queries and vice-versa, (the piece that was talking directly to the frontend) was consistently returning an error <strong>500</strong>, and this happened because the triples that were introduced into the database using a script were generated wrong and had all the same <em>id</em> for every different model.</p>
<p>Let's say that you have a file with this structure:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">&lt;url1:concept1&gt; &lt;predicate1&gt; &lt;foo&gt; ;
	&lt;predicate2&gt; &lt;bar&gt; ;
	&lt;predicate3&gt; &lt;baz&gt; .

&lt;url1:concept2&gt; &lt;predicate1&gt; &lt;foo&gt; ;
	&lt;predicate2&gt; &lt;bar&gt; ;
	&lt;predicate3&gt; &lt;baz&gt; .
</code></pre></div><p>And you want to detect each &ldquo;foo&rdquo; ocurrence and add a unique identifier, generated for example with the bash <strong>uuidgen</strong> utility, At the beginning this was the code:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">blog λ cat example.txt | sed &#34;s/foo/$(uuidgen)/g&#34;
&lt;url1:concept1&gt; &lt;predicate1&gt; &lt;66fa7661-889f-4ed5-b74d-540e18b9a83d&gt; ;
        &lt;predicate2&gt; &lt;bar&gt; ;
        &lt;predicate3&gt; &lt;baz&gt; .

&lt;url1:concept2&gt; &lt;predicate1&gt; &lt;66fa7661-889f-4ed5-b74d-540e18b9a83d&gt; ;
        &lt;predicate2&gt; &lt;bar&gt; ;
        &lt;predicate3&gt; &lt;baz&gt; .

</code></pre></div><p>But then the <em>uuid</em> was generated only once, and substituted in all occurrences. We need to substitute each new &ldquo;foo&rdquo; appearance by a different <em>uuid</em> each time! Ah but <strong>sed</strong> allows you to pass an external command per each match, so you could do this in theory:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">blog λ cat a.txt
foo
foo
c
d

blog λ cat a.txt | sed <span style="color:#a31515">&#34;</span><span style="color:#a31515">s/foo/echo </span><span style="color:#00f">$(</span>uuidgen<span style="color:#00f">)</span><span style="color:#a31515">/ge</span><span style="color:#a31515">&#34;</span>
8b8cc7ac-b089-4339-875c-76a5278b594a
8b8cc7ac-b089-4339-875c-76a5278b594a
b
c
d
</code></pre></div><p>Damn!, <strong>sed</strong> still only evaluates the command call once and does the substitution for each occurrence! But what if we manage to execute a command that depends on an external random source to generate the <em>uuid</em>? I found a little snippet <a href="https://gist.github.com/earthgecko/3089509">here</a>.</p>
<p>So we try adapting it to work with <strong>sed</strong>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">blog λ cat a.txt | sed <span style="color:#a31515">&#34;</span><span style="color:#a31515">s^foo^cat /dev/urandom | tr -dc &#39;a-zA-Z0-9&#39; | fold -w </span><span style="color:#a31515">${</span>1<span style="color:#00f">:-</span>32<span style="color:#a31515">}</span><span style="color:#a31515"> | head -n 1^ge</span><span style="color:#a31515">&#34;</span>
13YFcSxzshlFocig6AdA7yEbHeSKYq4r
6jhDEL3x3yDUsOf6mqScrea29YNDDURy
b
c
d

</code></pre></div><p>Nice, now each occurrence of &ldquo;foo&rdquo; is replaced by a random string. So let's try with the original file <strong>example.txt</strong>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">blog λ cat example.txt | sed <span style="color:#a31515">&#34;</span><span style="color:#a31515">s^foo^cat /dev/urandom | tr -dc &#39;a-zA-Z0-9&#39; | fold -w </span><span style="color:#a31515">${</span>1<span style="color:#00f">:-</span>32<span style="color:#a31515">}</span><span style="color:#a31515"> | head -n 1^ge</span><span style="color:#a31515">&#34;</span>
sh: 1: Syntax error: redirection unexpected

        &lt;predicate2&gt; &lt;bar&gt; ;
        &lt;predicate3&gt; &lt;baz&gt; .

sh: 1: Syntax error: redirection unexpected

        &lt;predicate2&gt; &lt;bar&gt; ;
        &lt;predicate3&gt; &lt;baz&gt; .
</code></pre></div><p>Argh, why the hell this happens?.. redirections are with the &ldquo;&lt;&rdquo; character in the unix shell. Oh wait, could it be that <strong>sed</strong> is not only taking the exact match but the whole line? or the characters next to it? Let's verify it. Let's say that now this is <strong>a.txt</strong>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">blog λ cat a.txt
foo <span style="">&lt;</span> /etc/passwd
foo
b
c
d

blog λ cat a.txt | sed &#34;s/foo/cat/ge&#34;
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
... etc ...
b
c
d
</code></pre></div><p>Yes, it is substituting &ldquo;foo&rdquo; by cat but receives also the &ldquo;&lt; /etc/passwd&rdquo; and interprets not as text but as part of the commmand to execute inside <strong>sed</strong>.</p>
<h2 id="the-solution">The Solution</h2>
<p>The solution came using <strong>awk</strong>. This is the line that did the trick, it will add a specific triple with a new uuid for each <strong><a href="url:concept">url:concept</a></strong>.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">blog λ cat example.txt | awk <span style="color:#a31515">&#39;1;/foo/{command=&#34;uuidgen&#34;;command | getline uuidgen;close(command); print &#34;\t&lt;http://our.namespace.url&gt; \&#34;&#34; uuidgen &#34;\&#34; ;&#34;}&#39;</span>
&lt;url1:concept1&gt; &lt;predicate1&gt; &lt;foo&gt; ;
        &lt;http://our.namespace.url&gt; <span style="color:#a31515">&#34;802a44bd-c28f-4856-b275-e24c666308c8&#34;</span> ;
        &lt;predicate2&gt; &lt;bar&gt; ;
        &lt;predicate3&gt; &lt;baz&gt; .

&lt;url1:concept2&gt; &lt;predicate1&gt; &lt;foo&gt; ;
        &lt;http://our.namespace.url&gt; <span style="color:#a31515">&#34;6b8cbac2-70c4-4769-b065-5aa36af797a4&#34;</span> ;
        &lt;predicate2&gt; &lt;bar&gt; ;
        &lt;predicate3&gt; &lt;baz&gt; .

</code></pre></div><p>Special thanks to my colleague <a href="https://wdullaer.com/">@wdullaer</a> for asking me to help him out with Ember and we end up having fun with <strong>sed</strong> &amp; <strong>awk</strong>.</p>
<p>Have fun!</p>

			</div>

			<div class="tags">
				
					
						<ul class="flat">
							
							<li><a href="/tags/sed">sed</a></li>
							
							<li><a href="/tags/awk">awk</a></li>
							
							<li><a href="/tags/bash">bash</a></li>
							
							<li><a href="/tags/commandline">commandline</a></li>
							
						</ul>
					
				
			</div><div id="disqus_thread"></div>
<script type="text/javascript">
	(function () {
		
		
		if (window.location.hostname == "localhost")
			return;

		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		var disqus_shortname = 'ink-demo';
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
		Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-99848055-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script>feather.replace()</script>
</body>
</html>
