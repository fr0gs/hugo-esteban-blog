<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Writing a simple Inverted Index in Python - Esteban Sastre</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Writing a simple Inverted Index in Python" />
<meta property="og:description" content="Introduction Nowadays is not uncommon that web applications include full text search features. There are already well known solutions working out-of-the-box that provide the needed functionalities, such as ElasticSearch or Apache Solr.
Having used ElasticSearch at work a couple of times I wondered how it achieved fast searches and what mechanism empowered that, so reading up a little on the topic, the Inverted Index appears as the cornerstone of full text search algorithms." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/writing-a-simple-inverted-index-in-python/" />
<meta property="article:published_time" content="2018-10-22T12:47:56+00:00" />
<meta property="article:modified_time" content="2018-10-22T12:47:56+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Writing a simple Inverted Index in Python"/>
<meta name="twitter:description" content="Introduction Nowadays is not uncommon that web applications include full text search features. There are already well known solutions working out-of-the-box that provide the needed functionalities, such as ElasticSearch or Apache Solr.
Having used ElasticSearch at work a couple of times I wondered how it achieved fast searches and what mechanism empowered that, so reading up a little on the topic, the Inverted Index appears as the cornerstone of full text search algorithms."/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" /><link rel="stylesheet" type="text/css" href="/css/dark.css" media="(prefers-color-scheme: dark)" />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
		<script src="/js/main.js"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
		<div class="avatar">
			<a href="/">
				<img src="wizard.png" alt="Esteban Sastre" />
			</a>
		</div>
	
	<h1 class="site-title"><a href="/">Esteban Sastre</a></h1>
	<div class="site-description"><p>Pretty much everything that crosses my mind, thoughts and ramblings</p><nav class="nav social">
			<ul class="flat"><li><a href="https://github.com/fr0gs/" title="Github"><i data-feather="github"></i></a></li><li><a href="/index.xml" title="RSS"><i data-feather="rss"></i></a></li></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">22</span>
							<span class="rest">Oct 2018</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">Writing a simple Inverted Index in Python</h1>
				</div>
			</div>
					
			<div class="markdown">
				<h1 id="introduction">Introduction</h1>
<p>Nowadays is not uncommon that web applications include full text search features. There are already well known solutions working out-of-the-box that provide the needed functionalities, such as <a href="https://www.elastic.co/" title="ElasticSearch">ElasticSearch</a> or <a href="https://lucene.apache.org/solr/" title="Solr">Apache Solr</a>.</p>
<p>Having used <strong>ElasticSearch</strong> at work a couple of times I wondered how it achieved fast searches and what mechanism empowered that, so reading up a little on the topic, the <em>Inverted Index</em> appears as the cornerstone of full text search algorithms.</p>
<p>Thus, what better way to understand how something works than writing my own toy one?</p>
<h1 id="what-is-an-inverted-index">What is an Inverted Index?</h1>
<p>The <em>Inverted Index</em> is the data structure used to support full text search over a set of documents. It is constituted by a big table where there is one entry per word in all the documents processed, along with a list of the key pairs: document id, frequency of the term in the document.</p>
<h1 id="how-does-it-work">How does it work?</h1>
<p>Let's imagine we have two documents with different texts:</p>
<ol>
<li>The big sharks of Belgium drink beer.</li>
<li>Belgium has great beer. They drink beer all the time.</li>
</ol>
<p>In order to create the <em>Inverted Index</em>, each text is sliced into different units or <strong>terms</strong>. The rule is to use whitespace as the natural separator between words, although it can be changed.</p>
<p>Additionally, per each term there is a list of pairs (<strong>document id</strong>, <strong>occurrences</strong>), showing the document's ID where the term is found, and the number of times the term appears in the text.</p>
<p>Therefore, the Inverted Index after processing the previous two documents would be:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">| Term    | Appearances (DocId, Frequency) |
|---------|----------------------------------|
| The     | (1, 1)                           |
| big     | (1, 1)                           |
| sharks  | (1, 1)                           |
| of      | (1, 1)                           |
| Belgium | (1, 1) (2, 1)                    |
| drink   | (1, 1)                           |
| beer    | (1, 1) (2, 2)                    |
| has     | (1, 1)                           |
| great   | (1, 1)                           |
| They    | (1, 1)                           |
| all     | (1, 1)                           |
| the     | (1, 1)                           |
| time    | (1, 1)                           |
</code></pre></div><p>As seen, the term <em>Belgium</em> appears once in both documents, while the term <em>beer</em> appears once in the first and twice in the second one. Whenever a search is issued, the index will be looked up and the corresponding documents retrieved automatically.</p>
<p>This in turn makes processing the documents (indexing) and thus creating &amp; updating the index a slow process, since each document needs to be parsed, sliced and analyzed. Conversely, once the index is created search becomes a really cheap operation since it only entails looking up an entry in a table.</p>
<p>As it happens with everything, this mechanism is not a silver bullet and it has it's quirks and drawbacks, being some of them:</p>
<ul>
<li><strong>Case</strong>: The words <code>Belgium</code> and <code>belgium</code> are indexed as two different terms in the table, while a user writing &ldquo;belgium&rdquo; in lowercase letters most likely would want to see all the occurrences regardless case.</li>
<li><strong>Stopwords</strong>: keywords considered irrelevant and deprived on any additional sense, like prepositions, articles or conjunctions.</li>
<li><strong>Stemming</strong>: Reducing derivations of a word to their common root (e.g: <code>shark</code> and <code>sharks</code> to <code>shark</code>).</li>
<li><strong>Synonyms</strong>: Gathering terms that share a common meaning to a single one, in order to prevent an explosion in Inverted Indexe's size. Terms like <code>car</code>, <code>automobile</code>, <code>plane</code> and <code>truck</code> could be mapped into a single <code>vehicle</code> word in the index.</li>
</ul>
<h1 id="example">Example</h1>
<p>The <em>Inverted Index</em> can be understood as a simple key/value dictionary where per each term we store a list of appearances of those terms in the documents and their frequency.</p>
<p>Thus, an Appearance class represents a single <em>Appearance</em> of a term in a document:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">class</span> <span style="color:#2b91af">Appearance</span>:
    <span style="color:#a31515"></span><span style="color:#a31515">&#34;&#34;&#34;</span><span style="color:#a31515">
</span><span style="color:#a31515"></span><span style="color:#a31515">    Represents the appearance of a term in a given document, along with the</span><span style="color:#a31515">
</span><span style="color:#a31515"></span><span style="color:#a31515">    frequency of appearances in the same one.</span><span style="color:#a31515">
</span><span style="color:#a31515"></span><span style="color:#a31515">    </span><span style="color:#a31515">&#34;&#34;&#34;</span>
    <span style="color:#00f">def</span> __init__(self, docId, frequency):
        self.docId = docId
        self.frequency = frequency

        
    <span style="color:#00f">def</span> __repr__(self):
        <span style="color:#a31515"></span><span style="color:#a31515">&#34;&#34;&#34;</span><span style="color:#a31515">
</span><span style="color:#a31515"></span><span style="color:#a31515">        String representation of the Appearance object</span><span style="color:#a31515">
</span><span style="color:#a31515"></span><span style="color:#a31515">        </span><span style="color:#a31515">&#34;&#34;&#34;</span>
        <span style="color:#00f">return</span> str(self.__dict__)

</code></pre></div><p>The <em>Database</em> class is a fake in-memory DB used to persist the documents after they have been indexed.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">class</span> <span style="color:#2b91af">Database</span>:
    <span style="color:#a31515"></span><span style="color:#a31515">&#34;&#34;&#34;</span><span style="color:#a31515">
</span><span style="color:#a31515"></span><span style="color:#a31515">    In memory database representing the already indexed documents.</span><span style="color:#a31515">
</span><span style="color:#a31515"></span><span style="color:#a31515">    </span><span style="color:#a31515">&#34;&#34;&#34;</span>
    <span style="color:#00f">def</span> __init__(self):
        self.db = dict()


    <span style="color:#00f">def</span> __repr__(self):
        <span style="color:#a31515"></span><span style="color:#a31515">&#34;&#34;&#34;</span><span style="color:#a31515">
</span><span style="color:#a31515"></span><span style="color:#a31515">        String representation of the Database object</span><span style="color:#a31515">
</span><span style="color:#a31515"></span><span style="color:#a31515">        </span><span style="color:#a31515">&#34;&#34;&#34;</span>
        <span style="color:#00f">return</span> str(self.__dict__)

    
    <span style="color:#00f">def</span> get(self, id):
        <span style="color:#00f">return</span> self.db.get(id, None)

    
    <span style="color:#00f">def</span> add(self, document):
        <span style="color:#a31515"></span><span style="color:#a31515">&#34;&#34;&#34;</span><span style="color:#a31515">
</span><span style="color:#a31515"></span><span style="color:#a31515">        Adds a document to the DB.</span><span style="color:#a31515">
</span><span style="color:#a31515"></span><span style="color:#a31515">        </span><span style="color:#a31515">&#34;&#34;&#34;</span>
        <span style="color:#00f">return</span> self.db.update({document[<span style="color:#a31515"></span><span style="color:#a31515">&#39;</span><span style="color:#a31515">id</span><span style="color:#a31515">&#39;</span>]: document})


    <span style="color:#00f">def</span> remove(self, document):
        <span style="color:#a31515"></span><span style="color:#a31515">&#34;&#34;&#34;</span><span style="color:#a31515">
</span><span style="color:#a31515"></span><span style="color:#a31515">        Removes document from DB.</span><span style="color:#a31515">
</span><span style="color:#a31515"></span><span style="color:#a31515">        </span><span style="color:#a31515">&#34;&#34;&#34;</span>
        <span style="color:#00f">return</span> self.db.pop(document[<span style="color:#a31515"></span><span style="color:#a31515">&#39;</span><span style="color:#a31515">id</span><span style="color:#a31515">&#39;</span>], None)

</code></pre></div><p>And finally, the <em>InvertedIndex</em> class.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">class</span> <span style="color:#2b91af">InvertedIndex</span>:
    <span style="color:#a31515"></span><span style="color:#a31515">&#34;&#34;&#34;</span><span style="color:#a31515">
</span><span style="color:#a31515"></span><span style="color:#a31515">    Inverted Index class.</span><span style="color:#a31515">
</span><span style="color:#a31515"></span><span style="color:#a31515">    </span><span style="color:#a31515">&#34;&#34;&#34;</span>
    <span style="color:#00f">def</span> __init__(self, db):
        self.index = dict()
        self.db = db


    <span style="color:#00f">def</span> __repr__(self):
        <span style="color:#a31515"></span><span style="color:#a31515">&#34;&#34;&#34;</span><span style="color:#a31515">
</span><span style="color:#a31515"></span><span style="color:#a31515">        String representation of the Database object</span><span style="color:#a31515">
</span><span style="color:#a31515"></span><span style="color:#a31515">        </span><span style="color:#a31515">&#34;&#34;&#34;</span>
        <span style="color:#00f">return</span> str(self.index)

        
    <span style="color:#00f">def</span> index_document(self, document):
        <span style="color:#a31515"></span><span style="color:#a31515">&#34;&#34;&#34;</span><span style="color:#a31515">
</span><span style="color:#a31515"></span><span style="color:#a31515">        Process a given document, save it to the DB and update the index.</span><span style="color:#a31515">
</span><span style="color:#a31515"></span><span style="color:#a31515">        </span><span style="color:#a31515">&#34;&#34;&#34;</span>
        
        <span style="color:#008000"># Remove punctuation from the text.</span>
        clean_text = re.sub(<span style="color:#a31515">r</span><span style="color:#a31515">&#39;</span><span style="color:#a31515">[^</span><span style="color:#a31515">\</span><span style="color:#a31515">w</span><span style="color:#a31515">\</span><span style="color:#a31515">s]</span><span style="color:#a31515">&#39;</span>,<span style="color:#a31515"></span><span style="color:#a31515">&#39;</span><span style="color:#a31515">&#39;</span>, document[<span style="color:#a31515"></span><span style="color:#a31515">&#39;</span><span style="color:#a31515">text</span><span style="color:#a31515">&#39;</span>])
        terms = clean_text.split(<span style="color:#a31515"></span><span style="color:#a31515">&#39;</span><span style="color:#a31515"> </span><span style="color:#a31515">&#39;</span>)
        appearances_dict = dict()

        <span style="color:#008000"># Dictionary with each term and the frequency it appears in the text.</span>
        <span style="color:#00f">for</span> term <span style="color:#00f">in</span> terms:
            term_frequency = appearances_dict[term].frequency <span style="color:#00f">if</span> term <span style="color:#00f">in</span> appearances_dict <span style="color:#00f">else</span> 0
            appearances_dict[term] = Appearance(document[<span style="color:#a31515"></span><span style="color:#a31515">&#39;</span><span style="color:#a31515">id</span><span style="color:#a31515">&#39;</span>], term_frequency + 1)
            
        <span style="color:#008000"># Update the inverted index</span>
        update_dict = { key: [appearance]
                       <span style="color:#00f">if</span> key <span style="color:#00f">not</span> <span style="color:#00f">in</span> self.index
                       <span style="color:#00f">else</span> self.index[key] + [appearance]
                       <span style="color:#00f">for</span> (key, appearance) <span style="color:#00f">in</span> appearances_dict.items() }

        self.index.update(update_dict)

        <span style="color:#008000"># Add the document into the database</span>
        self.db.add(document)

        <span style="color:#00f">return</span> document

    
    <span style="color:#00f">def</span> lookup_query(self, query):
        <span style="color:#a31515"></span><span style="color:#a31515">&#34;&#34;&#34;</span><span style="color:#a31515">
</span><span style="color:#a31515"></span><span style="color:#a31515">        Returns the dictionary of terms with their correspondent Appearances. </span><span style="color:#a31515">
</span><span style="color:#a31515"></span><span style="color:#a31515">        This is a very naive search since it will just split the terms and show</span><span style="color:#a31515">
</span><span style="color:#a31515"></span><span style="color:#a31515">        the documents where they appear.</span><span style="color:#a31515">
</span><span style="color:#a31515"></span><span style="color:#a31515">        </span><span style="color:#a31515">&#34;&#34;&#34;</span>
        <span style="color:#00f">return</span> { term: self.index[term] <span style="color:#00f">for</span> term <span style="color:#00f">in</span> query.split(<span style="color:#a31515"></span><span style="color:#a31515">&#39;</span><span style="color:#a31515"> </span><span style="color:#a31515">&#39;</span>) <span style="color:#00f">if</span> term <span style="color:#00f">in</span> self.index }

</code></pre></div><p>In order to test the execution of the index, I just create a couple documents and perform some searches.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">def</span> highlight_term(id, term, text):
    replaced_text = text.replace(term, <span style="color:#a31515"></span><span style="color:#a31515">&#34;</span><span style="color:#a31515">\033</span><span style="color:#a31515">[1;32;40m {term} </span><span style="color:#a31515">\033</span><span style="color:#a31515">[0;0m</span><span style="color:#a31515">&#34;</span>.format(term=term))
    <span style="color:#00f">return</span> <span style="color:#a31515"></span><span style="color:#a31515">&#34;</span><span style="color:#a31515">--- document {id}: {replaced}</span><span style="color:#a31515">&#34;</span>.format(id=id, replaced=replaced_text)


<span style="color:#00f">def</span> main():
    db = Database()
    index = InvertedIndex(db)

    document1 = {
        <span style="color:#a31515"></span><span style="color:#a31515">&#39;</span><span style="color:#a31515">id</span><span style="color:#a31515">&#39;</span>: <span style="color:#a31515"></span><span style="color:#a31515">&#39;</span><span style="color:#a31515">1</span><span style="color:#a31515">&#39;</span>,
        <span style="color:#a31515"></span><span style="color:#a31515">&#39;</span><span style="color:#a31515">text</span><span style="color:#a31515">&#39;</span>: <span style="color:#a31515"></span><span style="color:#a31515">&#39;</span><span style="color:#a31515">The big sharks of Belgium drink beer.</span><span style="color:#a31515">&#39;</span>
    }

    document2 = {
        <span style="color:#a31515"></span><span style="color:#a31515">&#39;</span><span style="color:#a31515">id</span><span style="color:#a31515">&#39;</span>: <span style="color:#a31515"></span><span style="color:#a31515">&#39;</span><span style="color:#a31515">2</span><span style="color:#a31515">&#39;</span>,
        <span style="color:#a31515"></span><span style="color:#a31515">&#39;</span><span style="color:#a31515">text</span><span style="color:#a31515">&#39;</span>: <span style="color:#a31515"></span><span style="color:#a31515">&#39;</span><span style="color:#a31515">Belgium has great beer. They drink beer all the time.</span><span style="color:#a31515">&#39;</span>
    }

    index.index_document(document1)
    index.index_document(document2)
    
    
    search_term = raw_input(<span style="color:#a31515"></span><span style="color:#a31515">&#34;</span><span style="color:#a31515">Enter term(s) to search: </span><span style="color:#a31515">&#34;</span>)
    result = index.lookup_query(search_term)

    
    <span style="color:#00f">for</span> term <span style="color:#00f">in</span> result.keys():
        <span style="color:#00f">for</span> appearance <span style="color:#00f">in</span> result[term]:
            <span style="color:#008000"># Belgium: { docId: 1, frequency: 1}</span>
            document = db.get(appearance.docId)
            <span style="color:#00f">print</span>(highlight_term(appearance.docId, term, document[<span style="color:#a31515"></span><span style="color:#a31515">&#39;</span><span style="color:#a31515">text</span><span style="color:#a31515">&#39;</span>]))
        <span style="color:#00f">print</span>(<span style="color:#a31515"></span><span style="color:#a31515">&#34;</span><span style="color:#a31515">-----------------------------</span><span style="color:#a31515">&#34;</span>)    
    
main()

</code></pre></div><p>Doing a couple searches we can see the result:</p>
<p><img src="/images/inverted1.png" alt="inverted1"></p>
<p>and another one.</p>
<p><img src="/images/inverted2.png" alt="inverted2"></p>
<p>I hope this served as a good introduction on how the Inverted Index works.</p>
<p>Have fun!</p>
<h1 id="references">References</h1>
<ul>
<li>
<p><a href="https://www.quora.com/What-is-inverted-index-It-is-a-well-known-fact-that-you-need-to-build-indexes-to-implement-efficient-searches-What-is-the-difference-between-index-and-inverted-index-and-how-does-one-build-inverted-index">Inverted Index in quora</a></p>
</li>
<li>
<p><a href="http://www.dcs.bbk.ac.uk/~dell/teaching/cc/book/ditp/ditp_ch4.pdf">Inverted Index for information Retrieval</a></p>
</li>
<li>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/inverted-index.html">Inverted Index Elasticsearch website</a></p>
</li>
<li>
<p><a href="https://stackoverflow.com/questions/12511543/how-to-build-a-simple-inverted-index">Inverted Index in StackOverflow</a></p>
</li>
<li>
<p><a href="https://github.com/felipehummel/TinySearchEngine/blob/master/scala/tinySearch.scala">Inverted Index implementation in scala</a></p>
</li>
<li>
<p><a href="https://nlpforhackers.io/building-a-simple-inverted-index-using-nltk/">Building an Inverted Index with NTLK</a></p>
</li>
<li>
<p><a href="https://legacy.python.org/workshops/1996-11/papers/InvertedIndex.html">Legacy Python Workshop Inverted Index</a></p>
</li>
</ul>

			</div>

			<div class="tags">
				
					
						<ul class="flat">
							
							<li><a href="/tags/python">python</a></li>
							
							<li><a href="/tags/learning">learning</a></li>
							
						</ul>
					
				
			</div><div id="disqus_thread"></div>
<script type="text/javascript">
	(function () {
		
		
		if (window.location.hostname == "localhost")
			return;

		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		var disqus_shortname = 'ink-demo';
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
		Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-99848055-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script>feather.replace()</script>
</body>
</html>
